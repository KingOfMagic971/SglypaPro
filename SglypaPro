# AutoCowAi
–ú–æ–¥—É–ª—å –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–∞–Ω–∏–µ –≤ –∫–æ—Ä–æ–≤–∫—É
#              _     _             _aa
#    _  Branch| |__ | | ___   ___ | |_  _   _
#   | |/ / _ \| '_ \| |/ _ \ / _ \| __|| | | |
#   |   < (_) | | | | | (_) | (_) | |_ | |_| |
#   |_|\_\___/|_| |_|_|\___/ \___/ \__| \__,_|
#
# meta developer: @k1sIotaa
# scope: auto_cow_pro

import asyncio
import re
from .. import loader, utils
from telethon.tl.types import Message

@loader.tds
class AutoCowAIMod(loader.Module):
    """AI-–ê–≤—Ç–æ–ö–æ—Ä–æ–≤–∫–∞: –õ–µ—Å, –î–æ–π–∫–∞, –ï–¥–∞ –∏ —Ñ–∏–ª—å—Ç—Ä –∂–∏–≤–æ—Ç–Ω—ã—Ö"""
    
    strings = {"name": "–ê–≤—Ç–æ–ö–æ—Ä–æ–≤–∫–∞ PRO"}

    def __init__(self):
        self.config = loader.ModuleConfig(
            loader.ConfigValue("chat_id", 0, "ID –∏–≥—Ä–æ–≤–æ–≥–æ —á–∞—Ç–∞"),
            loader.ConfigValue("forest", False, "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ª–µ—Å"),
            loader.ConfigValue("cow", False, "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–π–∫–∞"),
            loader.ConfigValue("eat", False, "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –µ–¥–∞ (50%+)"),
            loader.ConfigValue("skip_list", ["–¢–µ–¥–¥–∏", "–ë–µ–ª–æ—á–∫–∞", "–ñ–∞–±–æ–º—Ä–∞–∑—å", "–ï–¥–∏–Ω–æ—Ä–æ–∂–∫–∞", "–í–∏–Ω–¥–∏", "–î–∂—É–Ω"], "–ö–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å"),
        )
        self.active_tasks = {}

    @loader.command()
    async def cwg(self, message: Message):
        """–ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        await self.show_main_menu(message)

    async def show_main_menu(self, message):
        target = self.config["chat_id"] if self.config["chat_id"] != 0 else "–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù"
        text = (f"<b>üêÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ê–≤—Ç–æ–ö–æ—Ä–æ–≤–∫–∏</b>\n"
                f"<b>üìç –ß–∞—Ç:</b> <code>{target}</code>\n"
                f"<b>ü§ñ –°—Ç–∞—Ç—É—Å –ò–ò:</b> –ê–∫—Ç–∏–≤–µ–Ω")
        
        btns = [
            [
                ("üå≤ –õ–µ—Å: " + ("‚úÖ" if self.config["forest"] else "‚ùå"), "toggle_f"),
                ("üêÆ –î–æ–π–∫–∞: " + ("‚úÖ" if self.config["cow"] else "‚ùå"), "toggle_c")
            ],
            [
                ("ü•¶ –ï–¥–∞: " + ("‚úÖ" if self.config["eat"] else "‚ùå"), "toggle_e"),
                ("‚öôÔ∏è –£–∫–∞–∑–∞—Ç—å ID —á–∞—Ç–∞", "set_cid")
            ],
            [("üêæ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–µ—Å–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π", "set_anim")],
            [("‚ùå –ó–∞–∫—Ä—ã—Ç—å", "close")]
        ]
        await self.inline.form(message=message, text=text, reply_markup=btns)

    # --- CALLBACKS ---
    async def toggle_f_callback(self, call):
        self.config["forest"] = not self.config["forest"]
        await self.show_main_menu(call.message)

    async def toggle_c_callback(self, call):
        self.config["cow"] = not self.config["cow"]
        await self.show_main_menu(call.message)

    async def toggle_e_callback(self, call):
        self.config["eat"] = not self.config["eat"]
        await self.show_main_menu(call.message)

    async def set_cid_callback(self, call):
        async with self._client.conversation(call.sender_id) as conv:
            m = await conv.send_message("<b>–û—Ç–ø—Ä–∞–≤—å ID —á–∞—Ç–∞ –∏–ª–∏ –ø–µ—Ä–µ—à–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –±–æ—Ç–∞:</b>")
            r = await conv.get_reply()
            cid = r.chat_id if r.forward else int(r.text)
            self.config["chat_id"] = cid
            await m.edit(f"‚úÖ ID —á–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: <code>{cid}</code>")
            await self.show_main_menu(call.message)

    async def set_anim_callback(self, call):
        btns = []
        for anim in ["–¢–µ–¥–¥–∏", "–ë–µ–ª–æ—á–∫–∞", "–ñ–∞–±–æ–º—Ä–∞–∑—å", "–ï–¥–∏–Ω–æ—Ä–æ–∂–∫–∞", "–í–∏–Ω–¥–∏", "–î–∂—É–Ω"]:
            status = "‚úÖ" if anim in self.config["skip_list"] else "‚ùå"
            btns.append([(f"{anim} {status}", f"anim_{anim}")])
        btns.append([("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "back_main")])
        await call.edit("<b>üêæ –í—ã–±–µ—Ä–∏ –∫–æ–≥–æ –Ω—É–∂–Ω–æ –ü–†–û–ü–£–°–ö–ê–¢–¨:</b>", reply_markup=btns)

    async def anim_callback(self, call):
        anim_name = call.data.split("_")[1]
        current = list(self.config["skip_list"])
        if anim_name in current: current.remove(anim_name)
        else: current.append(anim_name)
        self.config["skip_list"] = current
        await self.set_anim_callback(call)

    # --- LOGIC ---
    async def watcher(self, message: Message):
        if not isinstance(message, Message) or message.chat_id != self.config["chat_id"]:
            return
        
        text = message.text or ""

        # 1. –ê–í–¢–û-–õ–ï–° (–¢–∞–π–º–µ—Ä—ã –∏ –ü—Ä–æ–ø—É—Å–∫)
        if self.config["forest"]:
            # –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –ª–µ—Å–∞
            timer = re.search(r"(?:—á–µ—Ä–µ–∑|–æ—Ç–∫–∞—Ç|–∂–¥–∞—Ç—å)\s*(\d+)\s*(?:–º–∏–Ω|–º)", text.lower())
            if timer:
                minutes = int(timer.group(1))
                await self.schedule_task("forest", minutes * 60, message.chat_id, "–ú—É–ª—Å")
            
            # –ï—Å–ª–∏ –ø–æ—è–≤–∏–ª–æ—Å—å –∂–∏–≤–æ—Ç–Ω–æ–µ –∏–∑ —Å–ø–∏—Å–∫–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            for anim in self.config["skip_list"]:
                if anim in text:
                    await asyncio.sleep(1)
                    await message.click(text="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å")
                    break

        # 2. –ê–í–¢–û-–î–û–ô–ö–ê
        if self.config["cow"]:
            if "–ø–æ—Ä–∞ –¥–æ–∏—Ç—å" in text.lower() or "–º–æ–∂–Ω–æ –ø–æ–¥–æ–∏—Ç—å" in text.lower():
                await self._client.send_message(message.chat_id, "–ú—É–∫")
                await asyncio.sleep(2)
                await message.click(text="–ü–æ–¥–æ–∏—Ç—å")

        # 3. –ê–í–¢–û-–ü–û–ï–î–ê–ù–ò–ï (–°—ã—Ç–æ—Å—Ç—å)
        if self.config["eat"]:
            hunger_match = re.search(r"–°—ã—Ç–æ—Å—Ç—å:\s*(\d+)%", text)
            if (hunger_match and int(hunger_match.group(1)) <= 50) or "–≥–æ–ª–æ–¥–∞–µ—Ç" in text.lower():
                await self._client.send_message(message.chat_id, "–ú—É–∫")
                await asyncio.sleep(2)
                # –ò—â–µ–º –∫–Ω–æ–ø–∫–∏ —Å –µ–¥–æ–π
                for btn in ["üåø", "ü•¶", "–¢—Ä–∞–≤–∫–∞", "–ë—Ä–æ–∫–∫–æ–ª–∏"]:
                    if await message.click(text=btn): break

    async def schedule_task(self, name, seconds, chat_id, command):
        """–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–æ–º–∞–Ω–¥"""
        task_id = f"{name}_{chat_id}"
        if task_id in self.active_tasks:
            self.active_tasks[task_id].cancel()
        
        async def _waiter():
            await asyncio.sleep(seconds + 2)
            await self._client.send_message(chat_id, command)
            del self.active_tasks[task_id]
        
        self.active_tasks[task_id] = asyncio.create_task(_waiter())

    @loader.command()
    async def auto_forest(self, message):
        """–í–∫–ª/–í—ã–∫–ª –ª–µ—Å"""
        self.config["forest"] = not self.config["forest"]
        await utils.answer(message, f"üå≤ –õ–µ—Å: {self.config['forest']}")

    @loader.command()
    async def auto_cow(self, message):
        """–í–∫–ª/–í—ã–∫–ª –¥–æ–π–∫—É"""
        self.config["cow"] = not self.config["cow"]
        await utils.answer(message, f"üêÆ –î–æ–π–∫–∞: {self.config['cow']}")

    @loader.command()
    async def auto_eating(self, message):
        """–í–∫–ª/–í—ã–∫–ª –µ–¥—É"""
        self.config["eat"] = not self.config["eat"]
        await utils.answer(message, f"ü•¶ –ï–¥–∞: {self.config['eat']}")
